#!/bin/sh
bundle=$1
[ -n "$bundle" ] || exit 0

# generate Qt config file
mkdir -p $bundle/Contents/Resources
( echo "[Paths]"; echo "Plugins = PlugIns" ) > $bundle/Contents/Resources/qt.conf

# copy resources
QT_INSTALL_LIBS=`qmake -query QT_INSTALL_LIBS`
cp -a $QT_INSTALL_LIBS/Resources/qt_menu.nib $bundle/Contents/Resources/

started=''
for input in "$@"; do
    if [ -z "$started" ]; then
        started="yes"
        continue
    fi
    inputdir=`dirname $input`
    name=`basename $inputdir`/`basename $input`
    plugin=$bundle/Contents/PlugIns/$name
    echo "Copying plugin $name"
    mkdir -p `dirname $plugin`
    cp $input $plugin
    filter=`basename $input`
    for dep in `otool -L $plugin | grep -v $filter | grep -v /usr/lib | grep -v /System/Library | cut -d" " -f1`; do
        dep_name=`echo $dep | sed -e 's/.*\/lib\///'`
        dep_id="@executable_path/../Frameworks/$dep_name"
        install_name_tool -change $dep $dep_id $plugin
        dep_inst="$bundle/Contents/Frameworks/$dep_name"
        if [ ! -e $dep_inst ]; then
            echo "Copying library $dep"
            mkdir -p `dirname $dep_inst`
            cp $dep $dep_inst
            install_name_tool -id $dep_id $dep_inst
        fi
    done
done

# Strip QT Framework to keep only "i386" part in case of a universal binary
# (if QT was installed as a binary from qt.nokia.com, it contains both i386 and ppc parts. WiLink is only supported and tested for i386)
for framework in `find $bundle/Contents/Frameworks -type f -name 'Qt*'`; do
    if file "$framework" | grep -q "universal"; then
        lipo -thin i386 -output "$framework.thin" "$framework" && mv "$framework.thin" "$framework"
    fi
done
