;--------------------------------
; You must define these values

  !define PRODUCT_NAME "wiLink"
  !define VERSION "2.4.90"
  !define PATCH  "90"
  !define INST_DIR ""

;--------------------------------
;Variables

  Var START_MENU
;--------------------------------
;Include Modern UI

  !include "MUI.nsh"

  ;Default installation folder
  InstallDir "$PROGRAMFILES\wiLink"

;--------------------------------
;General

  ;Name and file
  Name "wiLink"
  OutFile "..\wiLink-2.4.90.exe"

  ;Set compression
  SetCompressor lzma

  ;Require administrator access
  RequestExecutionLevel admin

  VIProductVersion 2.4.90.0
  VIAddVersionKey CompanyName "Wifirst"
  VIAddVersionKey FileDescription "wiLink 2.4.90"
  VIAddVersionKey FileVersion "2.4.90"
  VIAddVersionKey LegalCopyright "Copyright 2009-2015 Wifirst"
  VIAddVersionKey ProductName "wiLink"
  VIAddVersionKey ProductVersion "2.4.90"

;--------------------------------
;Interface Settings

  !define MUI_HEADERIMAGE
  !define MUI_ABORTWARNING

;--------------------------------
; path functions

!verbose 3
!include "WinMessages.NSH"
!verbose 4

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Uninstall sutff
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

###########################################
#            Utility Functions            #
###########################################

Function ConditionalAddToRegisty
  Pop $0
  Pop $1
  StrCmp "$0" "" ConditionalAddToRegisty_EmptyString
    WriteRegStr SHCTX "Software\Microsoft\Windows\CurrentVersion\Uninstall\wiLink" \
    "$1" "$0"
    ;MessageBox MB_OK "Set Registry: '$1' to '$0'"
    DetailPrint "Set install registry entry: '$1' to '$0'"
  ConditionalAddToRegisty_EmptyString:
FunctionEnd

;--------------------------------
;Pages
  !insertmacro MUI_PAGE_LICENSE "COPYING"
  !insertmacro MUI_PAGE_DIRECTORY

  !define MUI_FINISHPAGE_RUN "$INSTDIR\bin\wiLink.exe";

  !insertmacro MUI_PAGE_INSTFILES
  !insertmacro MUI_PAGE_FINISH

  !insertmacro MUI_UNPAGE_CONFIRM
  !insertmacro MUI_UNPAGE_INSTFILES

;--------------------------------
;Languages

  !insertmacro MUI_LANGUAGE "English" ;first language is the default language
  !insertmacro MUI_LANGUAGE "French"

;--------------------------------
;Installer Sections

Section "-Core installation"
  ;Use the entire tree produced by the INSTALL target.  Keep the
  ;list of directories here in sync with the RMDir commands below.
  SetOutPath "$INSTDIR"
  
  ;Make sure program is closed
  ExecWait '"taskkill.exe" /F /IM wiLink.exe' $0
  Sleep 1000

  ;Remove old registry keys
  DeleteRegKey SHCTX "Software\Humanity\wiLink 1.1.0"
  DeleteRegKey SHCTX "Software\Humanity\wiLink 2.0.1"
  DeleteRegKey SHCTX "Software\Humanity\wiLink 2.1.0"
  DeleteRegKey SHCTX "Software\Wifirst\wiLink 2.1.901"
  DeleteRegKey SHCTX "Software\Wifirst\wiLink 2.1.902"

  ;Remove old files
  ;File /r "${INST_DIR}\*.*"
  File /r bin

  ;Store installation folder
  WriteRegStr SHCTX "Software\Wifirst\wiLink" "" $INSTDIR

  ;Create uninstaller
  WriteUninstaller "$INSTDIR\Uninstall.exe"
  Push "DisplayName"
  Push "wiLink"
  Call ConditionalAddToRegisty
  Push "DisplayVersion"
  Push "2.4.90"
  Call ConditionalAddToRegisty
  Push "Publisher"
  Push "Wifirst"
  Call ConditionalAddToRegisty
  Push "UninstallString"
  Push "$INSTDIR\Uninstall.exe"
  Call ConditionalAddToRegisty
  Push "NoRepair"
  Push "1"
  Call ConditionalAddToRegisty

  ; Optional registration
  Push "DisplayIcon"
  Push "$INSTDIR\"
  Call ConditionalAddToRegisty
  Push "HelpLink"
  Push ""
  Call ConditionalAddToRegisty
  Push "URLInfoAbout"
  Push ""
  Call ConditionalAddToRegisty
  Push "Contact"
  Push ""
  Call ConditionalAddToRegisty

  ;Create shortcuts
  CreateDirectory "$SMPROGRAMS\${PRODUCT_NAME}"
  CreateShortCut "$SMPROGRAMS\${PRODUCT_NAME}\wiLink.lnk" "$INSTDIR\bin\wiLink.exe"
  CreateShortCut "$SMPROGRAMS\${PRODUCT_NAME}\Uninstall.lnk" "$INSTDIR\Uninstall.exe"

  ;Add protocol handler
  WriteRegStr HKCR "wilink" "" "URL:wilink"
  WriteRegStr HKCR "wilink" "URL Protocol" ""
  WriteRegStr HKCR "wilink\shell" "" ""
  WriteRegStr HKCR "wilink\shell\open" "" ""
  WriteRegStr HKCR "wilink\shell\open\command" "" "$INSTDIR\bin\wiLink.exe %1"

  ;In silent mode, automatically run program
  IfSilent 0 +2
  Exec "$INSTDIR\bin\wiLink.exe"
SectionEnd

Section "Uninstall"
  ;Purge program data
  RMDir /r "$LOCALAPPDATA\Wifirst\wiLink"
  RMDir "$LOCALAPPDATA\Wifirst"
  DeleteRegValue HKCU "Software\Microsoft\Windows\CurrentVersion\Run" "wiLink"
  DeleteRegKey HKCU "Software\Wifirst\wiLink"
  DeleteRegKey /ifempty HKCU "Software\Wifirst"

  ; Remove protocol handler
  DeleteRegKey HKCR "wilink"

  ;Remove the uninstaller itself.
  Delete "$INSTDIR\Uninstall.exe"
  DeleteRegKey SHCTX "Software\Microsoft\Windows\CurrentVersion\Uninstall\wiLink"

  ;Remove the installation directory.
  RMDir /r "$INSTDIR"

  ; Remove the registry entries.
  DeleteRegKey SHCTX "Software\Wifirst\wiLink"

  ; Remove shortcuts.
  RMDir /r "$SMPROGRAMS\${PRODUCT_NAME}"

  Push $INSTDIR\bin
SectionEnd
